# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Git Workflow

**CRITICAL**: This system uses YubiKey GPG signing. For automated commits, always use:
```bash
git cc-commit-msg "your commit message"
```
Never use regular `git commit` as it requires physical YubiKey touch interaction.

## Build and Deployment Commands

```bash
# Rebuild system configuration
rebuild

# Rebuild with package updates  
sudo nixos-rebuild switch --upgrade --flake ~/.nixos#gti

# Test configuration without switching
sudo nixos-rebuild test --flake ~/.nixos#gti

# Build configuration without applying
sudo nixos-rebuild build --flake ~/.nixos#gti

# Enter development shell with build tools
nix develop
```

## Architecture Overview

This is a modular NixOS configuration following DRY principles with the following key components:

### CRITICAL: Directory Structure and Separation of Concerns

**This hierarchy MUST be strictly maintained:**

```
.nixos/
├── flake.nix           # Entry point only - no other configs at root!
├── home.nix            # User configuration (home-manager)
│
├── systems/            # HOST-SPECIFIC configurations only
│   └── <hostname>/     # One directory per physical machine
│       ├── default.nix              # Main configuration entry point
│       └── hardware-configuration.nix # Generated by nixos-generate-config
│
├── hardware/           # REUSABLE hardware profiles only
│   └── <model>.nix     # Shared settings for hardware models (e.g., dell-xps-13-9370.nix)
│
└── modules/            # SHARED functionality only
    ├── base.nix        # Common configuration for ALL systems
    ├── options.nix     # Type definitions and configuration schema
    └── <function>.nix  # Feature modules (boot, networking, security, etc.)
```

**RULES:**
1. **NO configuration files in root** except flake.nix and home.nix
2. **systems/** = Instance-specific (YOUR laptop with UUID/hostname)
3. **hardware/** = Model-specific (ANY Dell XPS 13 9370)
4. **modules/** = Feature-specific (boot config, security, etc.)
5. **NEVER mix concerns** - if it's specific to one machine, it goes in systems/

### Core Structure
- **flake.nix**: Main flake with inputs (nixpkgs, home-manager, sops-nix, custom flakes)
- **systems/**: Host-specific configurations
  - **systems/gti/**: XPS 13 9370 configuration (production system)
  - **systems/transporter/**: Latitude 7280 configuration (test/development)
- **home.nix**: User-level configuration via home-manager
- **modules/base.nix**: Shared base configuration (nix settings, containers, users)
- **modules/options.nix**: Typed configuration options (replaces shared.nix)

### Module Organization
- **modules/boot.nix**: Boot loader, kernel parameters, memory management sysctls
- **modules/hardware.nix**: Dell XPS 13 9370 specific optimizations
- **modules/desktop.nix**: GNOME desktop environment with Wayland
- **modules/networking.nix**: NetworkManager with DNS-over-TLS
- **modules/security.nix**: AppArmor, fail2ban, auditd, YubiKey support (pcscd)
- **modules/performance.nix**: Storage optimization, zram, udev rules
- **modules/tools.nix**: Modern CLI tools (Rust-based), YubiKey packages, Fish shell config
- **modules/systemd.nix**: SystemD services and user session configuration
- **modules/secrets.nix**: Sops-nix encrypted secrets management

### Key Integrations
- **Secrets Management**: sops-nix with age encryption for system and user secrets
- **YubiKey Integration**: GPG signing, PIV/FIDO2 authentication, touch requirements
- **Home Manager**: Declarative user environment with Fish shell, Starship prompt, modern tools
- **Custom Flakes**: notion-mac-flake, claude-desktop-linux-flake for additional packages

## Adding a New System

When adding a new machine to this configuration:

1. **Create system directory**: `mkdir -p systems/<hostname>`
2. **Generate hardware config**: `nixos-generate-config --dir systems/<hostname>/`
3. **Create default.nix**: Copy from existing system and modify imports
4. **Create hardware profile** (if new model): Add to `hardware/<model>.nix`
5. **Update flake.nix**: Add new `nixosConfigurations.<hostname>` entry

**Example structure for new system "workstation":**
```
systems/workstation/
├── default.nix              # Imports base + hardware profile + specific modules
└── hardware-configuration.nix # Generated UUID/device specific config
```

### Navigation Aliases
- `nixos` - Navigate to ~/.nixos directory
- `projects` - Navigate to ~/projects directory

## Deployment-Only Modules

### Disko Module (modules/disko.nix)
- **Purpose**: Declarative disk partitioning for fresh installations
- **Current Usage**: transporter system only
- **Status**: Available for future deployments, not used by production systems
- **Use Case**: Fresh installations with automated disk setup

### Post-Install Module (modules/post-install.nix)
- **Purpose**: First-boot automation for new deployments
- **Current Usage**: transporter system only
- **Status**: Available for new system deployments
- **Features**: Automatic configuration validation, service activation, first-login setup

**Note**: These modules are deployment tools, not part of the core system configuration. They're kept for future fresh installations but aren't needed for existing systems.

## Development Notes

- **Directory structure is CRITICAL** - maintain strict separation of concerns
- Configuration uses typed options from `modules/options.nix` to avoid repetition
- All secrets are managed through sops-nix - never commit plain text secrets
- Each system imports: its hardware-configuration.nix + hardware profile + modules
- Fish shell with modern Rust-based CLI tools (eza, bat, fd, rg, etc.)
- GPG commit signing with YubiKey hardware security

## Common Mistakes to Avoid

1. **DON'T** put configuration files in the root directory
2. **DON'T** mix machine-specific and model-specific settings
3. **DON'T** duplicate configuration between systems - use modules/base.nix
4. **DON'T** put UUIDs or hostnames in hardware/ profiles
5. **DO** keep systems/<hostname>/ minimal - only unique settings